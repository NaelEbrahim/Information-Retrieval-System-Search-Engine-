{% extends 'base.html' %}

{% block content %}
<form action="{{ url_for('search') }}" method="get">
    <div class="flex-row">
        <select name="dataset" id="dataset">
            <option value="trec" {% if request.args.get('dataset') == 'trec' %}selected{% endif %}>TREC</option>
            <option value="antique" {% if request.args.get('dataset') == 'antique' %}selected{% endif %}>Antique</option>
        </select>
        <select name="model_type" id="model_type">
            <option value="tfidf" {% if request.args.get('model_type') == 'tfidf' %}selected{% endif %}>TF-IDF</option>
            <option value="word2vec" {% if request.args.get('model_type') == 'word2vec' %}selected{% endif %}>Word2Vec</option>
            <option value="hybrid" {% if request.args.get('model_type') == 'hybrid' %}selected{% endif %}>Hybrid</option>
        </select>
        <label for="alpha">Result Count:</label>
        <select name="top_n" id="top_n">
            <option value="10" {% if request.args.get('top_n') == '10' %}selected{% endif %}>10</option>
            <option value="20" {% if request.args.get('top_n') == '20' %}selected{% endif %}>20</option>
            <option value="50" {% if request.args.get('top_n') == '50' %}selected{% endif %}>50</option>
            <option value="-1" {% if request.args.get('top_n') == '-1' %}selected{% endif %}>All</option>
        </select>
    </div>
    <div class="search-container">
        <input class="search-bar" type="text" name="query" placeholder="Search..." value="{{ request.args.get('query', '') }}" required autocomplete="off">
        <div id="suggestions"></div>
    </div>
    <button class="search-btn" type="submit">Search</button>
</form>

<p id="dataset-info">
    trec is Tip of the tongue: The phenomenon of failing to retrieve something from memory, combined with partial recall and the feeling that retrieval is imminent.
</p>

<script>
    const searchBar = document.querySelector('.search-bar');
    const suggestionsDiv = document.getElementById('suggestions');

    const debounceTime = 300;

    const debounce = (fn, delay = 300) => {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn(...args), delay);
        };
    };

    searchBar.addEventListener('keyup', debounce(async () => {
        const query = searchBar.value;
        const dataset = document.getElementById('dataset').value;
        if (query.length < 3) {
            suggestionsDiv.innerHTML = '';
            return;
        }

        const response = await fetch(`/suggest?query=${query}&dataset=${dataset}`);
        const suggestions = await response.json();

        let html = '';
        suggestions.forEach(s => {
            html += `<div class="flex-row"><a class="suggestion-item" href="/search?query=${s}&dataset=${dataset}">${s}</a> <bold class="add-query">+</bold></div>`;
        });
        suggestionsDiv.innerHTML = html;
    }, debounceTime));

    // onchange datasets update dataset info
    document.getElementById('dataset').addEventListener('change', function() {
        const dataset = this.value;
        const datasetInfo = document.getElementById('dataset-info');
        if (dataset === 'trec') {
            datasetInfo.innerHTML = 'trec is Tip of the tongue: The phenomenon of failing to retrieve something from memory, combined with partial recall and the feeling that retrieval is imminent.';
        } else if (dataset === 'antique') {
            datasetInfo.innerHTML = 'ANTIQUE is a non-factoid question answering dataset based on the questions and answers of Yahoo! Webscope L6';
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-query')) {
            const query = e.target.previousElementSibling.textContent;
            searchBar.value = query;
            suggestionsDiv.innerHTML = '';
            searchBar.focus();
        }
    });
</script>

{% endblock %}
